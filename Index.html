<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HydroPro - Filling Glass Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #0ea5e9; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }

        .app-container { 
            background: var(--card); 
            padding: 2rem; 
            border-radius: 30px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
        }

        /* The Filling Glass Animation */
        .glass-wrapper {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 30px auto;
            border: 6px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 20px 20px;
            overflow: hidden;
            background: #fff;
            /* Tapered glass effect */
            clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 10% 100%);
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Dynamic */
            background: linear-gradient(180deg, #38bdf8 0%, #0ea5e9 100%);
            transition: height 1s linear; /* Smooth slow fill */
        }

        /* Wave effect at the top of the water */
        .water-fill::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 200%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 40%;
            animation: wave 4s infinite linear;
        }

        @keyframes wave {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        .timer-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: -10px; }
        .timer-display { font-size: 3.5rem; font-weight: 800; color: var(--text); margin-bottom: 20px; }

        .setup-box { background: #f1f5f9; padding: 15px; border-radius: 20px; margin-bottom: 20px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; font-size: 0.9rem; }
        input { width: 50px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center; font-weight: bold; }

        .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; transition: 0.3s; }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.4); }
        
        .stats { display: flex; justify-content: space-around; padding: 20px 0; border-top: 1px solid #f1f5f9; margin-top: 10px; }
        .stat-item b { font-size: 1.5rem; color: var(--primary); display: block; }
        .stat-item small { color: #64748b; font-weight: 600; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 style="margin-top:0; color: #0369a1;">ðŸ’§ HydroPro</h2>
    
    <div class="setup-box">
        <div class="input-row">
            <span>Daily Goal (Glasses)</span>
            <input type="number" id="goalInput" value="8" min="1">
        </div>
        <div class="input-row">
            <span>Active Hours</span>
            <input type="number" id="hoursInput" value="12" min="1">
        </div>
        <div id="calcText" style="font-size: 0.8rem; color: #64748b;">Interval: 90 mins</div>
    </div>

    <div class="timer-label">Next drink in</div>
    <div id="timer" class="timer-display">00:00</div>

    <div class="glass-wrapper">
        <div id="waterFill" class="water-fill"></div>
    </div>

    <button id="startBtn" class="btn-main">Start Hydrating</button>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="addGlassBtn" class="btn-main" style="background: #10b981;">+ Drink Glass</button>
        <button id="resetBtn" style="background:none; border:none; color:#94a3b8; cursor:pointer;">Reset</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <b id="drunkCount">0</b>
            <small>DRUNK</small>
        </div>
        <div class="stat-item">
            <b id="goalCount">8</b>
            <small>GOAL</small>
        </div>
    </div>

    <div id="alarmPopup" class="hidden" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#0ea5e9; color:white; padding:15px 30px; border-radius:50px; box-shadow:0 10px 20px rgba(0,0,0,0.2); font-weight:bold;">
        ðŸ“¢ Time to Drink Water!
    </div>
</div>

<audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    let state = {
        drunk: parseInt(localStorage.getItem('hp_v2_drunk')) || 0,
        goal: 8,
        hours: 12,
        intervalSeconds: 0,
        secondsLeft: 0
    };

    let ticker;
    const alarmAudio = document.getElementById('alarmSound');
    const waterFillEl = document.getElementById('waterFill');
    const timerEl = document.getElementById('timer');

    function calculate() {
        state.goal = parseInt(document.getElementById('goalInput').value) || 8;
        state.hours = parseInt(document.getElementById('hoursInput').value) || 12;
        
        const totalMinutes = state.hours * 60;
        const intervalMinutes = Math.floor(totalMinutes / state.goal);
        state.intervalSeconds = intervalMinutes * 60;
        
        document.getElementById('calcText').innerText = `Interval: ${intervalMinutes} mins`;
        document.getElementById('goalCount').innerText = state.goal;
        updateStats();
    }

    function updateStats() {
        document.getElementById('drunkCount').innerText = state.drunk;
        localStorage.setItem('hp_v2_drunk', state.drunk);
    }

    function startTimer() {
        calculate();
        state.secondsLeft = state.intervalSeconds;
        
        clearInterval(ticker);
        ticker = setInterval(() => {
            state.secondsLeft--;
            
            // Update Timer Text
            const m = Math.floor(state.secondsLeft / 60);
            const s = state.secondsLeft % 60;
            timerEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            // --- THE FILLING LOGIC ---
            // Calculate how much time has passed as a percentage
            const timePassed = state.intervalSeconds - state.secondsLeft;
            const fillPercentage = (timePassed / state.intervalSeconds) * 100;
            waterFillEl.style.height = fillPercentage + '%';

            if (state.secondsLeft <= 0) {
                triggerAlarm();
                state.secondsLeft = state.intervalSeconds; // Restart interval
            }
        }, 1000);

        if (Notification.permission !== 'granted') Notification.requestPermission();
    }

    function triggerAlarm() {
        alarmAudio.play();
        const popup = document.getElementById('alarmPopup');
        popup.classList.remove('hidden');
        setTimeout(() => popup.classList.add('hidden'), 5000);

        if (Notification.permission === 'granted') {
            new Notification("ðŸ’§ Time for Water!", { body: "Your glass is full. Drink up!" });
        }
    }

    // Controls
    document.getElementById('startBtn').addEventListener('click', startTimer);
    
    document.getElementById('addGlassBtn').addEventListener('click', () => {
        state.drunk++;
        updateStats();
        // Reset the timer and the glass when they actually drink
        state.secondsLeft = state.intervalSeconds;
        waterFillEl.style.height = '0%';
        
        if (state.drunk >= state.goal) {
            confetti({ particleCount: 150, spread: 70 });
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        if(confirm("Reset progress?")) { state.drunk = 0; updateStats(); }
    });

    // Auto-calculate on input change
    document.getElementById('goalInput').addEventListener('input', calculate);
    document.getElementById('hoursInput').addEventListener('input', calculate);

    calculate(); // Initial run
</script>
</body>
</html>